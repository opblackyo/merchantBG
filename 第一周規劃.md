# e-system-delivery API 文件

**Base URL**: `https://delivery-wqwi.onrender.com`

**Content-Type**: `application/json`

**Authentication**: Bearer Token (JWT)

## 1. 驗證與授權 (Authentication)

### 1.1 取得驗證碼 (Get Captcha)

在登入前需呼叫此 API 獲取圖形驗證碼與對應的 Token。

- **URL**: `/api/captcha`
- **Method**: `GET`
- **Response (200 OK)**:
    
    ```json
    {
      "captcha_token": "eyJhbGciOiJIUzI1...",
      "image": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA..."
    }
    
    ```
    

### 1.2 一般註冊 (Register)

- **URL**: `/api/register`
- **Method**: `POST`
- **Body**:
    
    ```json
    {
      "username": "justus123",
      "password": "mypassword",
      "confirm_password": "mypassword",
      "email": "example@gmail.com"
    }
    
    ```
    
- **Response (202 Accepted)**:
    
    ```json
    {
      "message": "註冊請求成功，請至您的 Gmail 信箱點擊驗證按鈕以啟用帳號。",
      "username": "justus123"
    }
    
    ```
    
- **Response (Error)**: 參見下方錯誤代碼表。

### 1.3 一般登入 (Login)

- **URL**: `/api/login`
- **Method**: `POST`
- **Body**:
    
    ```json
    {
      "username": "justus123",
      "password": "mypassword",
      "captcha_answer": "AB123",
      "captcha_token": "eyJhbGciOiJIUzI1..."
    }
    
    ```
    
- **Response (200 OK)**:
    
    ```json
    {
      "message": "登入成功",
      "token": "eyJhbGciOiJIUzI1Ni...",
      "user": "justus123",
      "expires_in": 1800
    }
    
    ```
    
- **Response (403 Forbidden)**: 帳號被鎖定。
    
    ```json
    { "message": "帳號鎖定中，請等待 300 秒" }
    
    ```
    
- **Response (400/401)**: 驗證碼錯誤或帳號密碼錯誤。

---

## 2. 會員功能 (User Profile) (未完成，之後可能改)

以下所有 API 皆需在 Header 帶入 JWT Token：

`Authorization: Bearer <your_token>`

### 2.1 取得個人資料 (Get Profile)

- **URL**: `/api/profile`
- **Method**: `GET`
- **Response (200 OK)**:
    
    ```json
    {
      "message": "test success",
      "user_id": 1,
      "username": "justus123",
      "email": "example@gmail.com",
      "display_name": "Justus",
      "is_line_linked": false,
      "is_google_linked": true
    }
    
    ```
    

### 2.2 修改使用者名稱 (Change Username)

- **URL**: `/api/user/username`
- **Method**: `POST`
- **Body**:
    
    ```json
    { "new_username": "new_name_justus" }
    
    ```
    
- **Response (200 OK)**:*注意：修改成功後會回傳新的 Token，舊 Token 雖然未過期但建議前端即時更新。*
    
    ```json
    {
      "message": "使用者名稱變更成功",
      "new_username": "new_name_justus",
      "token": "eyJhbGciOiJIUzI1...",
      "expires_in": 1800
    }
    
    ```
    

### 2.3 修改密碼 (Change Password)

- **URL**: `/api/user/password`
- **Method**: `POST`
- **Body**:
    
    ```json
    {
      "old_password": "old_password",
      "new_password": "new_password",
      "confirm_password": "new_password"
    }
    
    ```
    
- **Response (200 OK)**:
    
    ```json
    { "message": "密碼變更成功" }
    
    ```
    

---

## 3. 第三方登入與綁定 (OAuth)

### 3.1 取得第三方登入網址 (Login Init)

用於尚未登入的使用者進行快速登入。

- **URL**: `/api/login/line/init` 或 `/api/login/google/init`
- **Method**: `GET`
- **Response (200 OK)**: 
*前端動作：將使用者瀏覽器重新導向至 `auth_url`。*
    
    ```json
    { "auth_url": "https://accounts.google.com/o/oauth2/auth?..." }
    
    ```
    

### 3.2 取得第三方綁定網址 (Link Init)

用於**已登入**的使用者綁定外部帳號 (需帶 Token)。

- **URL**: `/api/link/line/init` 或 `/api/link/google/init`
- **Method**: `GET`
- **Headers**: `Authorization: Bearer <token>`
- **Response (200 OK)**:
    
    ```json
    {
      "message": "請導向此 URL 進行 ... 帳號綁定",
      "auth_url": "https://access.line.me/oauth2/v2.1/authorize?..."
    }
    
    ```
    

### 3.3 OAuth 回調 (Callback)

當使用者在第三方平台授權後，會被導回以下 URL。這些 API 會回傳 JSON 結果，前端需攔截處理。

- **URL**: `/api/callback/line` 或 `/api/callback/google`
- **Method**: `GET` (包含 query string: `code`, `state`)
- **Response (200 OK - 登入模式)**:
    
    ```json
    {
      "message": "登入成功" (或 "註冊成功並登入"),
      "token": "eyJhb...",
      "user": "justus123",
      "expires_in": 1800
    }
    
    ```
    
- **Response (200 OK - 綁定模式)**:
    
    ```json
    {
      "message": "LINE 帳號連結成功",
      "is_linked": true
    }
    
    ```
    

---

## 4. 錯誤代碼表 (Error Codes)

當 HTTP Status Code 為 `400`, `401`, `403`, `409`, `500` 時，Response Body 通常會包含 `error_code` 欄位供前端判斷（部分 API 僅回傳 message）。

### 通用/認證相關 (Authentication Errors)

| Error Code | HTTP Status | 說明 |
| --- | --- | --- |
| `MISSING_TOKEN` | 401 | Header 缺少 Authorization Token |
| `TOKEN_EXPIRED` | 401 | Token 已過期，請重新登入 |
| `INVALID_TOKEN` | 401 | Token 格式錯誤或無效 |
| `IP_BLOCKED` | 403 | 該 IP 因失敗次數過多被暫時封鎖 |

### 註冊相關 (Registration Errors)

| Error Code | HTTP Status | 說明 |
| --- | --- | --- |
| `INVALID_JSON` | 400 | Request Body 格式錯誤 |
| `EMPTY_FIELDS` | 400 | 必填欄位（帳號/密碼/Email）有空值 |
| `GMAIL_ONLY` | 400 | Email 網域限制僅能使用 @gmail.com |
| `PASSWORD_MISMATCH` | 400 | 確認密碼與密碼不一致 |
| `USER_EXISTS` | 409 | 帳號或 Email 已經被註冊 |
| `EMAIL_SEND_FAIL` | 500 | 系統無法發送驗證信 |
| `SERVER_ERROR` | 500 | 伺服器內部發生未預期錯誤 |

### 其他常見錯誤

- **401 Unauthorized**: 登入失敗（帳號密碼錯誤），或是修改密碼時舊密碼錯誤。
- **400 Bad Request**: 驗證碼錯誤、密碼長度不足（<6）、使用者名稱長度不足（<4）。
- **404 Not Found**: 找不到資源。